<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私密日记</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1', // 靛蓝色调
                        secondary: '#475569',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                },
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.1), 0 4px 6px -2px rgba(99, 102, 241, 0.05);
            }
            .hover-scale {
                transition: transform 0.2s ease;
            }
            .hover-scale:hover {
                transform: translateY(-2px);
            }
            .btn-primary {
                @apply bg-primary text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            .btn-primary:hover {
                @apply bg-primary/90;
            }
            .btn-secondary {
                @apply bg-secondary text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            .btn-secondary:hover {
                @apply bg-secondary/90;
            }
            .input-field {
                @apply w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200;
            }
            .textarea-field {
                @apply w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200 resize-none;
            }
        }
    </style>
    
    <!-- 全局样式 -->
    <style>
        body {
            background-color: #f8fafc;
            background-image: linear-gradient(to right, rgba(99, 102, 241, 0.03) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .diary-container {
            min-height: calc(100vh - 12rem);
        }
        .date-gradient {
            background: linear-gradient(90deg, rgba(99,102,241,0.1) 0%, rgba(99,102,241,0.03) 100%);
        }
    </style>
</head>
<body class="min-h-screen font-sans">
    <!-- 解锁模态框 -->
    <div id="lockModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <i class="fa fa-lock text-4xl text-primary mb-3"></i>
                <h2 class="text-2xl font-bold text-gray-800">解锁私密日记</h2>
                <p class="text-gray-500 mt-2">请输入密码访问您的日记</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="unlockPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="unlockPassword" class="input-field" placeholder="请输入密码">
                </div>
                <div id="unlockError" class="text-danger text-sm hidden">密码错误，请重试</div>
                <button id="unlockBtn" class="w-full btn-primary">
                    解锁
                </button>
                <button id="setPasswordBtn" class="w-full btn-secondary" style="display: none;">
                    设置密码
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8" id="appContainer" style="display: none;">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                <i class="fa fa-book text-primary mr-2"></i>私密日记
            </h1>
            <p class="text-secondary">记录您的生活点滴，安全保存</p>
        </header>
        
        <main class="diary-container">
            <!-- 日期选择器和工具 -->
            <div class="bg-white rounded-xl p-6 card-shadow mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex items-center gap-3 flex-1">
                        <input type="date" id="datePicker" class="flex-1 input-field">
                        <button id="todayBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center whitespace-nowrap">
                            <i class="fa fa-calendar-o mr-1"></i>今天
                        </button>
                        <div class="flex gap-2">
                            <button id="prevDayBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-3 rounded-lg transition-all duration-200">
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <button id="nextDayBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-3 rounded-lg transition-all duration-200">
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button id="changePasswordBtn" class="border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200">
                            <i class="fa fa-key mr-1"></i>修改密码
                        </button>
                        <button id="lockAppBtn" class="border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200">
                            <i class="fa fa-lock mr-1"></i>锁定
                        </button>
                    </div>
                </div>
                
                <!-- 日期显示 -->
                <div class="date-gradient mt-4 rounded-lg p-3">
                    <h2 id="currentDateDisplay" class="text-xl font-semibold text-primary"></h2>
                </div>
            </div>
            
            <!-- 日记内容区 -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- 左侧日记列表 -->
                <div class="lg:col-span-1 bg-white rounded-xl p-6 card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">
                            <i class="fa fa-list-alt text-primary mr-2"></i>已写日记
                        </h2>
                        <div class="flex items-center gap-2">
                            <select id="filterOption" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-1 focus:ring-primary focus:border-primary">
                                <option value="all">全部</option>
                                <option value="month">本月</option>
                                <option value="year">本年</option>
                            </select>
                        </div>
                    </div>
                    <div id="diaryList" class="space-y-2 max-h-[400px] overflow-y-auto pr-1">
                        <!-- 日记列表将通过JavaScript动态生成 -->
                        <div class="text-center py-10 text-gray-500">
                            <i class="fa fa-book text-3xl mb-2"></i>
                            <p>暂无日记记录</p>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧编辑区 -->
                <div class="lg:col-span-3 space-y-6">
                    <!-- 日记编辑 -->
                    <div class="bg-white rounded-xl p-6 card-shadow">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fa fa-pencil text-primary mr-2"></i>写日记
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <input type="text" id="diaryTitle" class="input-field" placeholder="日记标题（可选）">
                            </div>
                            <div>
                                <textarea id="diaryContent" class="textarea-field" rows="10" placeholder="今天有什么想记录的吗？"></textarea>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button id="saveBtn" class="btn-primary">
                                    <i class="fa fa-save mr-1"></i>保存
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GitHub同步 -->
                    <div id="githubSyncContainer" class="bg-white rounded-xl p-6 card-shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold flex items-center">
                                <i class="fa fa-github text-gray-800 mr-2"></i>GitHub同步
                            </h2>
                            <button id="hideSyncBtn" class="text-gray-400 hover:text-gray-600 flex items-center" title="隐藏">
                                <i class="fa fa-eye-slash mr-1"></i>隐藏
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="githubToken" class="block text-sm font-medium text-secondary mb-1">GitHub Token</label>
                                <input type="password" id="githubToken" class="input-field" placeholder="输入GitHub Token">
                            </div>
                            <div>
                                <label for="gistId" class="block text-sm font-medium text-secondary mb-1">Gist ID</label>
                                <input type="text" id="gistId" class="input-field" placeholder="输入Gist ID">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="syncToGithubBtn" class="btn-primary">
                                    <i class="fa fa-upload mr-1"></i>上传数据
                                </button>
                                <button id="syncFromGithubBtn" class="btn-primary">
                                    <i class="fa fa-download mr-1"></i>下载数据
                                </button>
                            </div>
                            <button id="autoSyncBtn" class="w-full btn-secondary">
                                自动关
                            </button>
                            <div id="syncStatus" class="sync-status info hidden text-center text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="mt-12 py-6 text-center text-gray-500 text-sm">
            <p>私密日记 &copy; 2025 | 您的私人记录空间</p>
        </footer>
    </div>
    
    <!-- 修改密码对话框 -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">修改密码</h2>
                <button id="closeChangePasswordModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div id="currentPasswordContainer">
                    <label for="currentPassword" class="block text-sm font-medium text-secondary mb-1">当前密码</label>
                    <input type="password" id="currentPassword" class="input-field" placeholder="请输入当前密码">
                </div>
                <div>
                    <label for="newPassword" class="block text-sm font-medium text-secondary mb-1">新密码</label>
                    <input type="password" id="newPassword" class="input-field" placeholder="请输入新密码">
                </div>
                <div>
                    <label for="confirmNewPassword" class="block text-sm font-medium text-secondary mb-1">确认新密码</label>
                    <input type="password" id="confirmNewPassword" class="input-field" placeholder="请再次输入新密码">
                </div>
                <div id="passwordError" class="text-danger text-sm hidden"></div>
                <div class="flex gap-3">
                    <button id="cancelChangePasswordBtn" class="flex-1 border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200">
                        取消
                    </button>
                    <button id="confirmChangePasswordBtn" class="flex-1 btn-primary">
                        确认修改
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 同步状态通知 -->
    <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <div class="flex items-center gap-2">
            <i id="notificationIcon" class="fa fa-info-circle"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>
    
    <script>
        // DOM元素
        const lockModal = document.getElementById('lockModal');
        const unlockPassword = document.getElementById('unlockPassword');
        const unlockBtn = document.getElementById('unlockBtn');
        const setPasswordBtn = document.getElementById('setPasswordBtn');
        const unlockError = document.getElementById('unlockError');
        const appContainer = document.getElementById('appContainer');
        const datePicker = document.getElementById('datePicker');
        const todayBtn = document.getElementById('todayBtn');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const diaryTitle = document.getElementById('diaryTitle');
        const diaryContent = document.getElementById('diaryContent');
        const saveBtn = document.getElementById('saveBtn');
        const diaryList = document.getElementById('diaryList');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const lockAppBtn = document.getElementById('lockAppBtn');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const closeChangePasswordModal = document.getElementById('closeChangePasswordModal');
        const cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn');
        const confirmChangePasswordBtn = document.getElementById('confirmChangePasswordBtn');
        const currentPassword = document.getElementById('currentPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmNewPassword = document.getElementById('confirmNewPassword');
        const passwordError = document.getElementById('passwordError');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationMessage = document.getElementById('notificationMessage');
        const filterOption = document.getElementById('filterOption');
        const currentPasswordContainer = document.getElementById('currentPasswordContainer');
        
        // GitHub同步相关元素
        const githubToken = document.getElementById('githubToken');
        const gistId = document.getElementById('gistId');
        const syncToGithubBtn = document.getElementById('syncToGithubBtn');
        const syncFromGithubBtn = document.getElementById('syncFromGithubBtn');
        const autoSyncBtn = document.getElementById('autoSyncBtn');
        const syncStatus = document.getElementById('syncStatus');
        const githubSyncContainer = document.getElementById('githubSyncContainer');
        const hideSyncBtn = document.getElementById('hideSyncBtn');
        
        // 常量和变量
        const STORAGE_KEY = 'private_diary_data';
        const PASSWORD_KEY = 'private_diary_password';
        let currentDate = new Date();
        let autoSync = false;
        let syncInterval = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已设置密码
            const hasPassword = localStorage.getItem(PASSWORD_KEY) !== null;
            if (!hasPassword) {
                unlockPassword.placeholder = '请设置您的密码';
                unlockBtn.style.display = 'none';
                setPasswordBtn.style.display = 'block';
                currentPasswordContainer.style.display = 'none';
            }
            
            // 设置今天日期
            setTodayDate();
        });
        
        // 设置今天日期
        function setTodayDate() {
            currentDate = new Date();
            datePicker.value = formatDate(currentDate);
            updateDisplayDate();
        }
        
        // 更新显示日期
        function updateDisplayDate() {
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const day = currentDate.getDate();
            const weekday = currentDate.getDay();
            
            currentDateDisplay.textContent = `${year}年${monthNames[month]}${day}日 ${weekdays[weekday]}`;
        }
        
        // 格式化日期
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 加载数据
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                return JSON.parse(data);
            }
            return {
                entries: {}
            };
        }
        
        // 保存数据
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        
        // 加载日记
        function loadDiary() {
            const data = loadData();
            const dateKey = formatDate(currentDate);
            const entry = data.entries[dateKey] || { title: '', content: '' };
            
            diaryTitle.value = entry.title;
            diaryContent.value = entry.content;
        }
        
        // 保存日记
        function saveDiary() {
            const data = loadData();
            const dateKey = formatDate(currentDate);
            
            data.entries[dateKey] = {
                title: diaryTitle.value.trim(),
                content: diaryContent.value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            saveData(data);
            updateDiaryList();
            
            // 如果启用了自动同步，保存后自动同步
            if (autoSync) {
                syncToGitHub();
            }
            
            showNotification('日记已保存', 'success');
        }
        
        // 更新日记列表
        function updateDiaryList() {
            const data = loadData();
            const entries = data.entries;
            const filteredEntries = filterDiaryEntries(entries);
            
            if (Object.keys(filteredEntries).length === 0) {
                diaryList.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fa fa-book text-3xl mb-2"></i>
                        <p>暂无日记记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期排序（最新的在前）
            const sortedDates = Object.keys(filteredEntries).sort((a, b) => new Date(b) - new Date(a));
            
            diaryList.innerHTML = '';
            
            sortedDates.forEach(date => {
                const entry = filteredEntries[date];
                const dateObj = new Date(date);
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                
                const listItem = document.createElement('div');
                listItem.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200 hover:border-primary/30 hover:bg-primary/5 transition-all duration-200 cursor-pointer';
                listItem.dataset.date = date;
                
                let displayDate = `${dateObj.getMonth() + 1}月${dateObj.getDate()}日 周${weekdays[dateObj.getDay()]}`;
                
                listItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-medium text-gray-800">${displayDate}</span>
                    </div>
                    <div class="text-sm ${entry.title ? 'font-medium text-primary' : 'text-gray-500'}">
                        ${entry.title || '(无标题)'}
                    </div>
                    <div class="text-xs text-gray-400 mt-1 line-clamp-1">
                        ${entry.content.substring(0, 30)}${entry.content.length > 30 ? '...' : ''}
                    </div>
                `;
                
                listItem.addEventListener('click', function() {
                    currentDate = new Date(date);
                    datePicker.value = formatDate(currentDate);
                    updateDisplayDate();
                    loadDiary();
                });
                
                diaryList.appendChild(listItem);
            });
        }
        
        // 过滤日记条目
        function filterDiaryEntries(entries) {
            const filter = filterOption.value;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            if (filter === 'all') {
                return entries;
            }
            
            const filtered = {};
            
            Object.keys(entries).forEach(date => {
                const dateObj = new Date(date);
                const entryMonth = dateObj.getMonth();
                const entryYear = dateObj.getFullYear();
                
                if (filter === 'month' && entryMonth === currentMonth && entryYear === currentYear) {
                    filtered[date] = entries[date];
                } else if (filter === 'year' && entryYear === currentYear) {
                    filtered[date] = entries[date];
                }
            });
            
            return filtered;
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            notificationMessage.textContent = message;
            
            // 设置样式
            if (type === 'success') {
                notification.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 bg-success text-white';
                notificationIcon.className = 'fa fa-check-circle';
            } else if (type === 'error') {
                notification.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 bg-danger text-white';
                notificationIcon.className = 'fa fa-exclamation-circle';
            } else {
                notification.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 bg-primary text-white';
                notificationIcon.className = 'fa fa-info-circle';
            }
            
            // 显示通知
            notification.style.transform = 'translateY(0)';
            notification.style.opacity = '1';
            
            // 3秒后隐藏
            setTimeout(() => {
                notification.style.transform = 'translateY(20px)';
                notification.style.opacity = '0';
            }, 3000);
        }
        
        // 解锁应用
        function unlockApp() {
            const password = unlockPassword.value;
            const storedPassword = localStorage.getItem(PASSWORD_KEY);
            
            // 简单的密码验证（实际应用中应使用更安全的加密方式）
            if (password === storedPassword) {
                lockModal.style.display = 'none';
                appContainer.style.display = 'block';
                loadDiary();
                updateDiaryList();
                loadSyncSettings();
                loadHideSyncSetting();
                
                // 如果启用了自动同步，启动定时器
                if (localStorage.getItem('autoSyncEnabled') === 'true') {
                    autoSyncBtn.textContent = '自动开';
                    autoSyncBtn.className = 'w-full bg-success text-white font-medium py-2 px-4 rounded-lg transition-all duration-200';
                    startAutoSync();
                }
            } else {
                unlockError.classList.remove('hidden');
                setTimeout(() => {
                    unlockError.classList.add('hidden');
                }, 3000);
            }
            
            unlockPassword.value = '';
        }
        
        // 设置密码
        function setPassword() {
            const password = unlockPassword.value;
            
            if (password.length < 4) {
                unlockError.textContent = '密码长度至少为4位';
                unlockError.classList.remove('hidden');
                setTimeout(() => {
                    unlockError.classList.add('hidden');
                }, 3000);
                return;
            }
            
            localStorage.setItem(PASSWORD_KEY, password);
            lockModal.style.display = 'none';
            appContainer.style.display = 'block';
            loadDiary();
            updateDiaryList();
            loadSyncSettings();
            loadHideSyncSetting();
            
            showNotification('密码设置成功', 'success');
        }
        
        // 修改密码
        function changePassword() {
            const hasPassword = localStorage.getItem(PASSWORD_KEY) !== null;
            
            if (hasPassword) {
                const currentPass = currentPassword.value;
                const storedPassword = localStorage.getItem(PASSWORD_KEY);
                
                if (currentPass !== storedPassword) {
                    passwordError.textContent = '当前密码错误';
                    passwordError.classList.remove('hidden');
                    return;
                }
            }
            
            const newPass = newPassword.value;
            const confirmPass = confirmNewPassword.value;
            
            if (newPass.length < 4) {
                passwordError.textContent = '新密码长度至少为4位';
                passwordError.classList.remove('hidden');
                return;
            }
            
            if (newPass !== confirmPass) {
                passwordError.textContent = '两次输入的密码不一致';
                passwordError.classList.remove('hidden');
                return;
            }
            
            localStorage.setItem(PASSWORD_KEY, newPass);
            changePasswordModal.style.display = 'none';
            
            // 重置表单
            currentPassword.value = '';
            newPassword.value = '';
            confirmNewPassword.value = '';
            passwordError.classList.add('hidden');
            
            showNotification('密码修改成功', 'success');
        }
        
        // 锁定应用
        function lockApplication() {
            lockModal.style.display = 'flex';
            appContainer.style.display = 'none';
            unlockPassword.value = '';
        }
        
        // GitHub同步相关函数
        function loadSyncSettings() {
            const token = localStorage.getItem('githubToken');
            const gistIdVal = localStorage.getItem('gistId');
            const auto = localStorage.getItem('autoSync') === 'true';
            
            if (token) githubToken.value = token;
            if (gistIdVal) gistId.value = gistIdVal;
            
            autoSync = auto;
            updateAutoSyncButton();
        }
        
        function updateAutoSyncButton() {
            autoSyncBtn.textContent = autoSync ? '自动开' : '自动关';
            autoSyncBtn.className = autoSync ? 
                'w-full bg-success text-white font-medium py-2 px-4 rounded-lg transition-all duration-200' : 
                'w-full btn-secondary';
        }
        
        function showSyncStatus(message, type = 'info') {
            syncStatus.textContent = message;
            syncStatus.className = `sync-status ${type} text-center text-sm`;
            syncStatus.style.display = 'block';
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 3000);
        }
        
        function saveSyncSettings() {
            const token = githubToken.value.trim();
            const gistIdVal = gistId.value.trim();
            
            if (token) localStorage.setItem('githubToken', token);
            if (gistIdVal) localStorage.setItem('gistId', gistIdVal);
        }
        
        async function syncToGitHub() {
            saveSyncSettings();
            const token = githubToken.value.trim();
            const gistIdVal = gistId.value.trim();
            
            if (!token) {
                showSyncStatus('请输入GitHub Token', 'error');
                return;
            }
            
            showSyncStatus('上传中...', 'info');
            
            const data = loadData();
            const syncData = {
                description: '私密日记数据',
                public: false,
                files: {
                    'private-diary-data.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            };
            
            try {
                let response;
                if (gistIdVal) {
                    response = await fetch(`https://api.github.com/gists/${gistIdVal}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(syncData)
                    });
                } else {
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(syncData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    if (!gistIdVal) {
                        gistId.value = result.id;
                        localStorage.setItem('gistId', result.id);
                    }
                    showSyncStatus('上传成功！', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showSyncStatus(`上传失败: ${error.message}`, 'error');
            }
        }
        
        async function syncFromGitHub() {
            saveSyncSettings();
            const token = githubToken.value.trim();
            const gistIdVal = gistId.value.trim();
            
            if (!token || !gistIdVal) {
                showSyncStatus('请输入Token和Gist ID', 'error');
                return;
            }
            
            showSyncStatus('下载中...', 'info');
            
            try {
                const response = await fetch(`https://api.github.com/gists/${gistIdVal}`, {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const fileContent = result.files['private-diary-data.json']?.content;
                    
                    if (fileContent) {
                        const remoteData = JSON.parse(fileContent);
                        if (!remoteData.entries) {
                            throw new Error('数据格式不正确');
                        }
                        saveData(remoteData);
                        loadDiary();
                        updateDiaryList();
                        showSyncStatus('下载成功！', 'success');
                    } else {
                        showSyncStatus('未找到数据', 'error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showSyncStatus(`下载失败: ${error.message}`, 'error');
            }
        }
        
        // 切换自动同步
        function autoSyncToggle() {
            autoSync = !autoSync;
            localStorage.setItem('autoSync', autoSync);
            localStorage.setItem('autoSyncEnabled', autoSync);
            updateAutoSyncButton();
            
            if (autoSync) {
                startAutoSync();
                showSyncStatus('自动同步已开启', 'success');
            } else {
                stopAutoSync();
                showSyncStatus('自动同步已关闭', 'info');
            }
        }
        
        // 开始自动同步
        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                syncFromGitHub();
            }, 60000); // 每60秒同步一次
        }
        
        // 停止自动同步
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }
        
        // 加载隐藏状态设置
        function loadHideSyncSetting() {
            // 默认隐藏GitHub同步，除非明确设置为不隐藏
            const isHidden = localStorage.getItem('githubSyncHidden') !== 'false';
            if (isHidden) {
                githubSyncContainer.style.display = 'none';
                // 添加显示按钮到页面
                if (!document.getElementById('showSyncBtn')) {
                    const showBtn = document.createElement('button');
                    showBtn.id = 'showSyncBtn';
                    showBtn.className = 'fixed bottom-5 left-5 p-3 bg-primary text-white rounded-full shadow-lg z-50';
                    showBtn.innerHTML = '<i class="fa fa-github"></i>';
                    showBtn.title = '显示GitHub同步';
                    document.body.appendChild(showBtn);
                    showBtn.addEventListener('click', showGitHubSync);
                }
            }
        }
        
        // 隐藏GitHub同步模块
        function hideGitHubSync() {
            githubSyncContainer.style.display = 'none';
            localStorage.setItem('githubSyncHidden', 'true');
            
            // 创建显示按钮
            const showBtn = document.createElement('button');
            showBtn.id = 'showSyncBtn';
            showBtn.className = 'fixed bottom-5 left-5 p-3 bg-primary text-white rounded-full shadow-lg z-50';
            showBtn.innerHTML = '<i class="fa fa-github"></i>';
            showBtn.title = '显示GitHub同步';
            document.body.appendChild(showBtn);
            showBtn.addEventListener('click', showGitHubSync);
            
            showNotification('GitHub同步已隐藏', 'success');
        }
        
        // 显示GitHub同步模块
        function showGitHubSync() {
            githubSyncContainer.style.display = 'block';
            localStorage.setItem('githubSyncHidden', 'false');
            
            // 移除显示按钮
            const showBtn = document.getElementById('showSyncBtn');
            if (showBtn) {
                document.body.removeChild(showBtn);
            }
            
            showNotification('GitHub同步已显示', 'success');
        }
        
        // 事件监听器
        datePicker.addEventListener('change', function() {
            currentDate = new Date(this.value);
            updateDisplayDate();
            loadDiary();
        });
        
        todayBtn.addEventListener('click', setTodayDate);
        
        prevDayBtn.addEventListener('click', function() {
            currentDate.setDate(currentDate.getDate() - 1);
            datePicker.value = formatDate(currentDate);
            updateDisplayDate();
            loadDiary();
        });
        
        nextDayBtn.addEventListener('click', function() {
            currentDate.setDate(currentDate.getDate() + 1);
            datePicker.value = formatDate(currentDate);
            updateDisplayDate();
            loadDiary();
        });
        
        saveBtn.addEventListener('click', saveDiary);
        
        unlockBtn.addEventListener('click', unlockApp);
        
        setPasswordBtn.addEventListener('click', setPassword);
        
        lockAppBtn.addEventListener('click', lockApplication);
        
        changePasswordBtn.addEventListener('click', function() {
            changePasswordModal.style.display = 'flex';
            passwordError.classList.add('hidden');
        });
        
        closeChangePasswordModal.addEventListener('click', function() {
            changePasswordModal.style.display = 'none';
        });
        
        cancelChangePasswordBtn.addEventListener('click', function() {
            changePasswordModal.style.display = 'none';
        });
        
        confirmChangePasswordBtn.addEventListener('click', function() {
            passwordError.classList.add('hidden');
            changePassword();
        });
        
        filterOption.addEventListener('change', updateDiaryList);
        
        // GitHub同步事件监听器
        syncToGithubBtn.addEventListener('click', syncToGitHub);
        
        syncFromGithubBtn.addEventListener('click', syncFromGitHub);
        
        autoSyncBtn.addEventListener('click', autoSyncToggle);
        
        hideSyncBtn.addEventListener('click', hideGitHubSync);
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === changePasswordModal) {
                changePasswordModal.style.display = 'none';
            }
        });
        
        // 键盘事件
        document.addEventListener('keydown', function(event) {
            // 在解锁界面按下Enter键
            if (event.key === 'Enter' && lockModal.style.display !== 'none') {
                const hasPassword = localStorage.getItem(PASSWORD_KEY) !== null;
                if (hasPassword) {
                    unlockApp();
                } else {
                    setPassword();
                }
            }
            
            // 在编辑日记时按下Ctrl+S保存
            if ((event.ctrlKey || event.metaKey) && event.key === 's' && lockModal.style.display === 'none') {
                event.preventDefault();
                saveDiary();
            }
        });
    </script>
</body>
</html>
